<div class="flex items-center justify-between mb-4">
  <div class="flex items-center space-x-4">
    <button
      pButton
      icon="pi pi-arrow-left"
      class="p-button-text"
      (click)="goBack()"
    ></button>
    <div>
      <div class="text-xl font-semibold">
        {{ isNewArticle ? '新建文章' : '编辑文章' }}
      </div>
      <div class="text-sm text-muted-color" *ngIf="!isNewArticle">
        文章ID: {{ articleId }}
      </div>
    </div>
  </div>
  <div class="flex items-center space-x-2">
    <button
      pButton
      [icon]="isSidebarVisible ? 'pi pi-arrow-right' : 'pi pi-arrow-left'"
      [label]="isSidebarVisible ? '隐藏属性' : '显示属性'"
      class="p-button-secondary p-button-text"
      (click)="toggleSidebar()"
    ></button>
    <button
      pButton
      [label]="saving ? '保存中...' : '保存'"
      [icon]="saving ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
      class="p-button-success"
      (click)="saveArticle()"
      [disabled]="saving || loading"
    ></button>
  </div>
</div>

<div class="flex gap-4">
  <div
    class="transition-all duration-300 flex-grow"
    [ngClass]="{
      'w-full lg:w-8/12': isSidebarVisible,
      'w-full': !isSidebarVisible
    }"
  >
    <p-card class="lg:h-full wd:h-fit flex flex-col">
      <ng-template pTemplate="title">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">文章内容</div>
          <button
            pButton
            [icon]="isPreviewVisible ? 'pi pi-eye-slash' : 'pi pi-eye'"
            [label]="isPreviewVisible ? '隐藏预览' : '显示预览'"
            class="p-button-text p-button-sm"
            (click)="togglePreview()"
          ></button>
        </div>
      </ng-template>

      <div class="h-[70dvh]">
        <div *ngIf="isPreviewVisible" class="h-full">
          <p-splitter
            [panelSizes]="[50, 50]"
            [style]="{ height: '100%' }"
            layout="horizontal"
          >
            <ng-template pTemplate>
              <div class="w-full h-full">
                <textarea
                  pInputTextarea
                  [(ngModel)]="article.s3_content"
                  placeholder="请输入文章内容..."
                  rows="20"
                  class="w-full h-full font-mono text-sm editor-textarea"
                  [disabled]="saving || loading"
                ></textarea>
              </div>
            </ng-template>
            <ng-template pTemplate>
              <div class="w-full h-full preview-container overflow-y-auto">
                <app-markdown-viewer
                  [markdownText]="article.s3_content || ''"
                ></app-markdown-viewer>
              </div>
            </ng-template>
          </p-splitter>
        </div>
        <div *ngIf="!isPreviewVisible" class="w-full h-full">
          <textarea
            pInputTextarea
            [(ngModel)]="article.s3_content"
            placeholder="请输入文章内容..."
            rows="20"
            class="w-full h-full font-mono text-sm editor-textarea"
            [disabled]="saving || loading"
          ></textarea>
        </div>
      </div>
    </p-card>
  </div>

  <div
    class="transition-all duration-300 flex-shrink-0"
    [ngClass]="{
      'w-full lg:w-4/12': isSidebarVisible,
      'hidden': !isSidebarVisible
    }"
  >
    <p-card>
      <ng-template pTemplate="title">文章内容</ng-template>

      <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2">文章标题 *</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="article.title"
            placeholder="请输入文章标题"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">副标题</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="article.subtitle"
            placeholder="请输入副标题"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>
      </div>

      <ng-template pTemplate="title">文章属性</ng-template>

      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">所属主题</label>
          <p-select
            [options]="themes"
            [(ngModel)]="selectedThemeId"
            optionLabel="name"
            optionValue="id"
            placeholder="选择主题"
            (onChange)="onThemeChange()"
            class="w-full"
            [disabled]="saving || loading"
          >
          </p-select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">所属章节 *</label>
          <p-select
            [options]="chapters"
            [(ngModel)]="selectedChapterId"
            optionLabel="name"
            optionValue="id"
            placeholder="选择章节"
            (onChange)="onChapterChange()"
            class="w-full"
            [disabled]="saving || loading || !selectedThemeId"
          >
          </p-select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">排序</label>
          <input
            pInputText
            type="number"
            [(ngModel)]="article.order"
            placeholder="0"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>

        <div class="flex items-center">
          <p-checkbox
            [(ngModel)]="article.is_active"
            [binary]="true"
            [disabled]="saving || loading"
            inputId="isActive"
          >
          </p-checkbox>
          <label for="isActive" class="ml-2 text-sm">激活状态</label>
        </div>
      </div>
    </p-card>

    <!-- 文章统计信息 -->
    <p-card class="mt-4" *ngIf="!isNewArticle">
      <ng-template pTemplate="title">统计信息</ng-template>

      <div class="grid grid-cols-1 gap-2 text-sm">
        <div class="flex justify-between">
          <span class="text-muted-color">创建时间:</span>
          <span>{{ article.inserted_at | date:'yyyy-MM-dd HH:mm' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-muted-color">更新时间:</span>
          <span>{{ article.updated_at | date:'yyyy-MM-dd HH:mm' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-muted-color">内容长度:</span>
          <span>{{ article.s3_content?.length || 0 }} 字符</span>
        </div>
      </div>
    </p-card>
  </div>
</div>

<!-- 消息提示 -->
<p-toast></p-toast>
