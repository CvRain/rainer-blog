<div class="flex items-center justify-between mb-4">
  <div class="flex items-center space-x-4">
    <button
      pButton
      icon="pi pi-arrow-left"
      class="p-button-text"
      (click)="goBack()"
    ></button>
    <div>
      <div class="text-xl font-semibold">
        {{ isNewArticle ? '新建文章' : '编辑文章' }}
      </div>
      <div class="text-sm text-muted-color" *ngIf="!isNewArticle">
        文章ID: {{ articleId }}
      </div>
    </div>
  </div>
  <div class="flex items-center space-x-2">
    <button
      pButton
      [icon]="isSidebarVisible ? 'pi pi-arrow-right' : 'pi pi-arrow-left'"
      [label]="isSidebarVisible ? '隐藏属性' : '显示属性'"
      class="p-button-secondary p-button-text"
      (click)="toggleSidebar()"
    ></button>
    <button
      pButton
      [label]="saving ? '保存中...' : '保存'"
      [icon]="saving ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
      class="p-button-success"
      (click)="saveArticle()"
      [disabled]="saving || loading"
    ></button>
  </div>
</div>

<div class="grid grid-cols-12 gap-4">
  <div
    class="transition-all duration-300"
    [ngClass]="{
      'col-span-12 lg:col-span-8': isSidebarVisible,
      'col-span-12': !isSidebarVisible
    }"
  >
    <p-card class="h-full">
      <p-tabs class="h-fit" value="0">
        <p-tablist>
          <p-tab value="0">编辑</p-tab>
          <p-tab value="1">预览</p-tab>
        </p-tablist>
        <p-tabpanels>
          <p-tabpanel value="0">
            <textarea
              pInputTextarea
              [(ngModel)]="article.s3_content"
              placeholder="请输入文章内容..."
              rows="20"
              class="w-full h-full font-mono text-sm editor-textarea"
              [disabled]="saving || loading"
            >
            </textarea>
          </p-tabpanel>
          <p-tabpanel value="1">
            <div class="w-full h-full preview-container">
              <app-markdown-viewer
                [markdownText]="article.s3_content || ''"
              ></app-markdown-viewer>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </p-card>
  </div>

  <!-- 右侧：文章属性设置 -->
  <div
    class="transition-all duration-300"
    [ngClass]="{
      'col-span-12 lg:col-span-4': isSidebarVisible,
      'hidden': !isSidebarVisible
    }"
  >
    <p-card>
      <ng-template pTemplate="title">文章内容</ng-template>

      <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2">文章标题 *</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="article.title"
            placeholder="请输入文章标题"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">副标题</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="article.subtitle"
            placeholder="请输入副标题"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>
      </div>

      <ng-template pTemplate="title">文章属性</ng-template>

      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">所属主题</label>
          <p-select
            [options]="themes"
            [(ngModel)]="selectedThemeId"
            optionLabel="name"
            optionValue="id"
            placeholder="选择主题"
            (onChange)="onThemeChange()"
            class="w-full"
            [disabled]="saving || loading"
          >
          </p-select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">所属章节 *</label>
          <p-select
            [options]="chapters"
            [(ngModel)]="selectedChapterId"
            optionLabel="name"
            optionValue="id"
            placeholder="选择章节"
            (onChange)="onChapterChange()"
            class="w-full"
            [disabled]="saving || loading || !selectedThemeId"
          >
          </p-select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">排序</label>
          <input
            pInputText
            type="number"
            [(ngModel)]="article.order"
            placeholder="0"
            class="w-full"
            [disabled]="saving || loading"
          />
        </div>

        <div class="flex items-center">
          <p-checkbox
            [(ngModel)]="article.is_active"
            [binary]="true"
            [disabled]="saving || loading"
            inputId="isActive"
          >
          </p-checkbox>
          <label for="isActive" class="ml-2 text-sm">激活状态</label>
        </div>
      </div>
    </p-card>

    <!-- 文章统计信息 -->
    <p-card class="mt-4" *ngIf="!isNewArticle">
      <ng-template pTemplate="title">统计信息</ng-template>

      <div class="grid grid-cols-1 gap-2 text-sm">
        <div class="flex justify-between">
          <span class="text-muted-color">创建时间:</span>
          <span>{{ article.inserted_at | date:'yyyy-MM-dd HH:mm' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-muted-color">更新时间:</span>
          <span>{{ article.updated_at | date:'yyyy-MM-dd HH:mm' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-muted-color">内容长度:</span>
          <span>{{ article.s3_content?.length || 0 }} 字符</span>
        </div>
      </div>
    </p-card>
  </div>
</div>

<!-- 消息提示 -->
<p-toast></p-toast>
